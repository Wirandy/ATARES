<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Jerawat - Fokus Wajah</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #1a1a1a; color: #fff; padding: 20px; margin: 0; }
        
        /* Layout Container */
        .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
        .box { background: #2d2d2d; padding: 15px; border-radius: 12px; width: 100%; max-width: 500px; position: relative; }
        
        h3 { margin-top: 0; color: #4CAF50; }

        /* --- CSS UNTUK AREA KAMERA & OVERLAY (PENTING) --- */
        .camera-wrapper {
            position: relative;
            width: 100%;
            /* Aspek rasio kotak (sesuaikan selera) */
            height: 400px; 
            overflow: hidden;
            border-radius: 10px;
            background: black;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Biar video full layar */
            transform: scaleX(-1); /* Mirror Mode */
        }

        /* Kotak Panduan (Overlay) */
        .scan-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            /* Teknik Border buat bikin efek "Gelap di luar kotak" */
            /* Border 1000px warna hitam transparan, tengahnya bolong */
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.6); 
            border: 2px solid #00ff00; /* Garis Hijau */
            border-radius: 150px; /* Bentuk Oval (Wajah) */
            
            /* Posisikan di tengah */
            width: 280px; 
            height: 350px;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }

        /* Teks Instruksi */
        .scan-text {
            position: absolute;
            bottom: 20px; left: 0; right: 0;
            text-align: center;
            color: #00ff00;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
            z-index: 11;
        }

        /* --- HASIL --- */
        img { 
            width: 100%; 
            border-radius: 10px; 
            display: none; 
            border: 2px solid #00ff00;
            transform: scaleX(1); /* Jangan dimirror lagi */
        }

        button { 
            margin-top: 15px; padding: 15px; width: 100%; 
            font-size: 18px; font-weight: bold; cursor: pointer; 
            background: #00ff00; color: #000; border: none; border-radius: 8px; 
            transition: 0.3s;
        }
        button:hover { background: #00cc00; }

        pre { text-align: left; background: #000; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 13px; color: #0f0; max-height: 300px;}
    </style>
</head>
<body>

    <h1>üéØ AI SCANNER (FOKUS WAJAH)</h1>

    <div class="container">
        <div class="box">
            <h3>üì∏ Posisikan Wajah di Kotak</h3>
            
            <div class="camera-wrapper">
                <video id="video" autoplay playsinline></video>
                
                <div class="scan-overlay"></div>
                <div class="scan-text">Pastikan wajah pas di dalam garis hijau</div>
            </div>

            <button onclick="tembakAI()">üîç SCAN SEKARANG</button>
        </div>

        <div class="box">
            <h3>üìä Hasil Analisa</h3>
            <p id="loadingText" style="display:none;">‚è≥ Mengirim ke AI... Tunggu bentar...</p>
            <img id="gambarHasil" alt="Hasil">
            <pre id="teksHasil">Menunggu scan...</pre>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        
        // Ukuran Kotak Crop (Harus sama/proporsional dengan CSS .scan-overlay)
        // Kita set agak besar biar resolusinya bagus
        const CROP_WIDTH = 480; 
        const CROP_HEIGHT = 600;

        // 1. Nyalakan Kamera (HD)
        navigator.mediaDevices.getUserMedia({
            video: { width: { ideal: 1280 }, height: { ideal: 720 } }
        }).then(stream => {
            video.srcObject = stream;
        }).catch(err => alert("Kamera Error: " + err));

        // 2. Fungsi Potong & Kirim
        function tembakAI() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // Kita set ukuran canvas sesuai ukuran CROP (bukan ukuran video full)
            canvas.width = CROP_WIDTH;
            canvas.height = CROP_HEIGHT;

            // HITUNG POSISI TENGAH (Math Magic)
            // Video asli mungkin 1280x720. Kita mau ambil tengahnya aja.
            const sourceX = (video.videoWidth - CROP_WIDTH) / 2;
            const sourceY = (video.videoHeight - CROP_HEIGHT) / 2;

            // GAMBAR (CROP) DARI TENGAH VIDEO KE CANVAS
            // drawImage(source, startX, startY, cropW, cropH, placeX, placeY, placeW, placeH)
            ctx.drawImage(video, 
                sourceX, sourceY, CROP_WIDTH, CROP_HEIGHT, // Ambil bagian tengah video
                0, 0, CROP_WIDTH, CROP_HEIGHT              // Taruh di canvas penuh
            );

            // Kirim ke Python
            canvas.toBlob(blob => {
                const formData = new FormData();
                formData.append("file", blob, "face_crop.jpg");

                // UI update
                document.getElementById('loadingText').style.display = 'block';
                document.getElementById('gambarHasil').style.display = 'none';
                document.getElementById('teksHasil').innerText = "Sedang mikir...";

                fetch("http://127.0.0.1:8001/detect", { method: "POST", body: formData })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('loadingText').style.display = 'none';
                    console.log(data);

                    if (data.image_result) {
                        const img = document.getElementById('gambarHasil');
                        img.src = data.image_result;
                        img.style.display = 'block';
                    }
                    
                    // Format Teks JSON biar enak dibaca
                    let info = "STATUS: " + data.status + "\n\n";
                    if(data.counts) info += "JERAWAT DITEMUKAN:\n" + JSON.stringify(data.counts, null, 2) + "\n\n";
                    if(data.expert_advice && data.expert_advice.length > 0) {
                        info += "üíä SARAN DOKTER:\n";
                        data.expert_advice.forEach(adv => {
                            info += `[${adv.type.toUpperCase()}]\nObat: ${adv.treatment}\nSaran: ${adv.advice}\n\n`;
                        });
                    } else {
                        info += "Wajah Tampak Bersih / Tidak ada saran khusus.";
                    }

                    document.getElementById('teksHasil').innerText = info;
                })
                .catch(err => {
                    alert("Error: " + err);
                    document.getElementById('loadingText').style.display = 'none';
                });
            }, 'image/jpeg', 0.95);
        }
    </script>
</body>
</html>